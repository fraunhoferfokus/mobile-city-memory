function errorLocationCallback(e){userLocation.moveToLocation(this.DEFAULT_LAT,this.DEFAULT_LONG),alert("There was an error obtaining your position. Message: "+e.message)}function addMarker(e){var t=parseFloat(e.latitude._int)*Math.pow(10,e.latitude._exp),o=parseFloat(e.longitude._int)*Math.pow(10,e.longitude._exp),i=e.entries.length;if(i>9&&(i=0),!userLocation.markers.hasOwnProperty(e.id)){var n=new google.maps.Marker({map:userLocation.map,position:new google.maps.LatLng(t,o),title:e.label,icon:"/static/stadtgedaechtnis/img/marker_"+i+".png",animation:google.maps.Animation.DROP});e.marker=n,createInfobox(e,0),userLocation.markers[e.id]=e}}function createInfobox(e,t){var o="<p class='infowindow'>"+e.entries[t].abstract+"</p>",i=new google.maps.InfoWindow({content:o,maxWidth:225});e.infobox=i,google.maps.event.clearListeners(e.marker,"click"),google.maps.event.addListener(e.marker,"click",function(){openEntry(e,t,!1)}),google.maps.event.addListener(i,"closeclick",closeEntry)}function reloadInfobox(e,t){t>=e.entries.length?t=0:0>t&&(t=e.entries.length-1),createInfobox(e,t),openEntry(e,t,!0)}function loadAdditionalEntry(e,t){$("article#entry-more").html(""),$("img#load-more").show(),$.get("../stadtgedaechtnis/entry/"+e.entries[t].id+"/",function(e){$("article#entry-more").html(e),$("img#load-more").hide()})}function openEntry(e,t,o){if(!o){for(var i="",n=0;n<e.entries.length;n++)i+="<li><h3>"+e.entries[n].title+"</h3></li>";$("div.article-heading div.entry-list ul").html(i)}if(void 0!==e.entries[t].image?$("section#article-section img#entry-first").show().attr({src:e.entries[t].image,alt:e.entries[t].alt}):$("section#article-section img#entry-first").hide(),loadAdditionalEntry(e,t),null===userLocation.currentInfobox){var a=$("section#article-section"),r=$("section#article-section h3");a.css("padding","0.8rem"),$(window).width()<768?(channel="mobile",a.transition({height:footerHeight},200,"ease"),r.swipe("enable"),$("main").transition({paddingBottom:footerHeight,marginBottom:"-"+footerHeight},200,"ease",function(){o||$("section#article-section div.entry-list").unslider()})):(r.swipe("disable"),channel="desktop",a.css({height:"100%",width:"0%"}),$("section.max_map").transition({width:"80%"},200,"ease"),a.transition({width:"20%"},200,"ease",function(){o||$("section#article-section div.entry-list").unslider()}),a.css("overflow-y","auto"))}else userLocation.currentInfobox.close();userLocation.currentInfobox=e.infobox,e.infobox.open(userLocation.map,e.marker),e.entries.length>1?($("div.article-heading").show(),$("div.article-heading img#previous").unbind("click").click(function(){$("section#article-section div.entry-list").data("unslider").next(),reloadInfobox(e,t+1)}),$("div.article-heading img#next").unbind("click").click(function(){$("section#article-section div.entry-list").data("unslider").prev(),reloadInfobox(e,t-1)})):$("div.article-heading").hide()}function closeEntry(){var e=$("section#article-section");"mobile"===channel?(e.transition({height:0},200,"ease"),$("main").transition({paddingBottom:"0px",marginBottom:"0px"},200,"ease",function(){e.css("padding","0rem")})):(e.transition({width:"0%"},200,"ease",function(){e.css({height:"100%",padding:"0rem",width:"auto"})}),$("section.max_map").transition({width:"100%"},200,"ease"),e.css("overflow-y","hidden")),null!==userLocation.currentInfobox&&(userLocation.currentInfobox.close(),userLocation.currentInfobox=null)}function searchForEntries(){var e=userLocation.map.getBounds(),t=e.getNorthEast().lat().toFixed(10),o=e.getNorthEast().lng().toFixed(10),i=e.getSouthWest().lat().toFixed(10),n=e.getSouthWest().lng().toFixed(10);$.getJSON("../stadtgedaechtnis/services/get-nearby-locations/"+i+"/"+t+"/"+n+"/"+o+"/",function(e){$.each(e,function(e,t){addMarker(t)})})}function Location(){this.DEFAULT_LAT=50.258,this.DEFAULT_LONG=10.965,this.DEFAULT_LOCATION=new google.maps.LatLng(50.258,10.965),this.positionMarker=null,this.markers={},this.currentInfobox=null}function initialize_Map(){userLocation.map=new google.maps.Map(document.getElementById(MAP_ELEMENT),mapOptions),userLocation.positionMarker=new GeolocationMarker(userLocation.map),userLocation.moveToCurrentLocationOrFallback(),google.maps.event.addListener(userLocation.positionMarker,"geolocation_error",errorLocationCallback),google.maps.event.addListener(userLocation.map,"idle",searchForEntries),google.maps.event.addListener(userLocation.map,"click",closeEntry)}var MAP_ELEMENT="map_canvas",channel="mobile";Location.prototype.moveToCurrentLocationOrFallback=function(){Modernizr.geolocation?google.maps.event.addListenerOnce(this.positionMarker,"position_changed",function(){this.map.setCenter(this.getPosition()),this.map.fitBounds(this.getBounds()),searchForEntries()}):this.moveToLocation(this.DEFAULT_LAT,this.DEFAULT_LONG)},Location.prototype.moveToLocation=function(e){this.map&&(this.map.panTo(e),searchForEntries())};var userLocation=new Location,mapOptions={center:userLocation.DEFAULT_LOCATION,zoom:17,mapTypeControl:!0,mapTypeId:google.maps.MapTypeId.SATELLITE,disableDefaultUI:!0,zoomControl:!0};