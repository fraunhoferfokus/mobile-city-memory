function errorLocationCallback(e){userLocation.moveToLocation(this.DEFAULT_LAT,this.DEFAULT_LONG),alert("There was an error obtaining your position. Message: "+e.message)}function addMarker(e){var t=parseFloat(e.latitude._int)*Math.pow(10,e.latitude._exp),i=parseFloat(e.longitude._int)*Math.pow(10,e.longitude._exp),n=e.entries.length;if(n>9&&(n=0),!userLocation.markers.hasOwnProperty(e.id)){var o=new google.maps.Marker({map:userLocation.map,position:new google.maps.LatLng(t,i),title:e.label,icon:"/static/stadtgedaechtnis/img/marker_"+n+".png",animation:google.maps.Animation.DROP});e.marker=o,createInfobox(e),userLocation.markers[e.id]=e}}function createInfobox(e){if(e.entries.length>1){for(var t="<div class='infowindow'><ul>",i=0;i<e.entries.length;i++)t+="<li><a href='#' class='switch-entry' data-entry='"+i+"'>"+e.entries[i].title+"</a></li>";t+="</ul></div>"}else var t="<div class='infowindow'><p>"+e.entries[0].abstract+"</p></div>";var n=new google.maps.InfoWindow({content:t,maxWidth:225});e.infobox=n,google.maps.event.clearListeners(e.marker,"click"),google.maps.event.addListener(e.marker,"click",function(){openEntry(e)}),google.maps.event.addListener(n,"closeclick",closeEntry)}function loadAdditionalEntry(e){var e=$(e),t=e.data("entry"),i=e.data("id");$("article#entry-more-"+t).html(""),$("img#load-more-"+t).show(),$.get("../stadtgedaechtnis/entry/"+i+"/",function(e){console.log("index: "+t),$("article#entry-more-"+t).html(e),$("img#load-more-"+t).hide()})}function openEntry(e){for(var t="",i=0;i<e.entries.length;i++)t+='<li data-entry="'+i+'" data-id="'+e.entries[i].id+'">                        <div class="article-heading">                            <div class="entry-slide"><img class="previous" src="/static/stadtgedaechtnis/img/left.png"></div>                            <h3 id="article-heading-'+i+'">'+e.entries[i].title+'</h3>                            <div class="entry-slide"><img class="next" src="/static/stadtgedaechtnis/img/right.png"></div>                        </div>',void 0!==e.entries[i].image&&(t+='<img src="'+e.entries[i].image+'" alt="'+e.entries[i].alt+'" id="entry-first-'+i+'"/>'),t+='<div class="center">                            <img src="/static/stadtgedaechtnis/img/ajax-loader.gif" id="load-more-'+i+'" class="load-more">                        </div>                        <article class="entry-more" id="entry-more-'+i+'">                        </article>                    </li>';if($("div.entry-list ul").html(t),e.entries.length>1?($("div.entry-slide").show(),$("div.article-heading img.previous").unbind("click").click(function(){$("section#article-section div.entry-list").data("unslider").prev()}),$("div.article-heading img.next").unbind("click").click(function(){$("section#article-section div.entry-list").data("unslider").next()})):$("div.entry-slide").hide(),loadAdditionalEntry($("div.entry-list ul li:first")),null===userLocation.currentInfobox){var n=$("section#article-section"),o=$("section#article-section h3");if(n.css("padding","0.8rem"),$(window).width()<768)channel="mobile",n.transition({height:footerHeight},200,"ease"),o.swipe("enable"),$("main").transition({paddingBottom:footerHeight,marginBottom:"-"+footerHeight},200,"ease",function(){$("section#article-section div.entry-list").unslider({complete:loadAdditionalEntry})});else{o.swipe("disable"),channel="desktop",n.css({height:"100%",width:"0%"});var a=$("section.max_map"),r=a.width();a.transition({width:r-380+"px"},200,"ease"),n.transition({width:"380px"},200,"ease",function(){$("section#article-section div.entry-list").unslider({complete:loadAdditionalEntry})}),n.css("overflow-y","auto")}}else userLocation.currentInfobox.close(),$("section#article-section div.entry-list").unslider().data("unslider").move(0);userLocation.currentInfobox=e.infobox,e.infobox.open(userLocation.map,e.marker),e.entries.length>1&&$("a.switch-entry").each(function(){$(this).click(function(){var e=$(this).data("entry");$("section#article-section div.entry-list").data("unslider").move(e)})})}function closeEntry(){var e=$("section#article-section");"mobile"===channel?(e.transition({height:0},200,"ease"),$("main").transition({paddingBottom:"0px",marginBottom:"0px"},200,"ease",function(){e.css("padding","0rem")})):(e.transition({width:"0%"},200,"ease",function(){e.css({height:"100%",padding:"0rem",width:"auto"})}),$("section.max_map").transition({width:"100%"},200,"ease"),e.css("overflow-y","hidden")),null!==userLocation.currentInfobox&&(userLocation.currentInfobox.close(),userLocation.currentInfobox=null)}function searchForEntries(){var e=userLocation.map.getBounds(),t=e.getNorthEast().lat().toFixed(10),i=e.getNorthEast().lng().toFixed(10),n=e.getSouthWest().lat().toFixed(10),o=e.getSouthWest().lng().toFixed(10);$.getJSON("../stadtgedaechtnis/services/get-nearby-locations/"+n+"/"+t+"/"+o+"/"+i+"/",function(e){$.each(e,function(e,t){addMarker(t)})})}function Location(){this.DEFAULT_LAT=50.258,this.DEFAULT_LONG=10.965,this.DEFAULT_LOCATION=new google.maps.LatLng(50.258,10.965),this.positionMarker=null,this.markers={},this.currentInfobox=null}function initialize_Map(){userLocation.map=new google.maps.Map(document.getElementById(MAP_ELEMENT),mapOptions),userLocation.positionMarker=new GeolocationMarker(userLocation.map),userLocation.moveToCurrentLocationOrFallback(),google.maps.event.addListener(userLocation.positionMarker,"geolocation_error",errorLocationCallback),google.maps.event.addListener(userLocation.map,"idle",searchForEntries),google.maps.event.addListener(userLocation.map,"click",closeEntry)}var MAP_ELEMENT="map_canvas",channel="mobile";Location.prototype.moveToCurrentLocationOrFallback=function(){Modernizr.geolocation?google.maps.event.addListenerOnce(this.positionMarker,"position_changed",function(){this.map.setCenter(this.getPosition()),this.map.fitBounds(this.getBounds()),searchForEntries()}):this.moveToLocation(this.DEFAULT_LAT,this.DEFAULT_LONG)},Location.prototype.moveToLocation=function(e){this.map&&(this.map.panTo(e),searchForEntries())};var userLocation=new Location,mapOptions={center:userLocation.DEFAULT_LOCATION,zoom:17,mapTypeControl:!0,mapTypeId:google.maps.MapTypeId.SATELLITE,disableDefaultUI:!0,zoomControl:!0};