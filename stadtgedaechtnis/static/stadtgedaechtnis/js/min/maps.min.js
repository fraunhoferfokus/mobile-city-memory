function errorLocationCallback(e){userLocation.moveToLocation(this.DEFAULT_LAT,this.DEFAULT_LONG),alert("There was an error obtaining your position. Message: "+e.message)}function addMarker(e){var o=parseFloat(e.latitude._int)*Math.pow(10,e.latitude._exp),t=parseFloat(e.longitude._int)*Math.pow(10,e.longitude._exp);if(!userLocation.markers.hasOwnProperty(e.id)){var n=new google.maps.Marker({map:userLocation.map,position:new google.maps.LatLng(o,t),title:e.label,icon:"/static/stadtgedaechtnis/img/marker_story.png",animation:google.maps.Animation.DROP});e.marker=n,createInfobox(e),userLocation.markers[e.id]=e}}function createInfobox(e){if(e.entries.length>1);else{e.heading=e.entries[0].title,e.image=e.entries[0].image,e.alt=e.entries[0].alt,e.entryid=e.entries[0].id;var o="<p class='infowindow'>"+e.entries[0].abstract+"</p>"}var t=new google.maps.InfoWindow({content:o,maxWidth:225});e.infobox=t,google.maps.event.addListener(e.marker,"click",function(){openEntry(e)}),google.maps.event.addListener(t,"closeclick",closeEntry)}function openEntry(e){if($("section#article-section h3").text(e.heading),$("section#article-section img#entry-first").attr({src:e.image,alt:e.alt}),$("article#entry-more").html(""),$("img#load-more").show(),$.get("../stadtgedaechtnis/entry/"+e.entryid+"/",function(e){$("article#entry-more").html(e),$("img#load-more").hide()}),null===userLocation.currentInfobox){var o=$("section#article-section");o.css("padding","0.8rem"),$(window).width()<768?(channel="mobile",o.transition({height:footerHeight},200,"ease"),o.swipe("enable"),$("main").transition({paddingBottom:footerHeight,marginBottom:"-"+footerHeight},200,"ease")):(o.swipe("disable"),channel="desktop",o.css({height:"100%",width:"0%"}),$("section.max_map").transition({width:"80%"},200,"ease"),o.transition({width:"20%"},200,"ease"))}else userLocation.currentInfobox.close();userLocation.currentInfobox=e.infobox,e.infobox.open(userLocation.map,e.marker)}function closeEntry(){var e=$("section#article-section");"mobile"===channel?(e.transition({height:0},200,"ease"),$("main").transition({paddingBottom:"0px",marginBottom:"0px"},200,"ease",function(){e.css("padding","0rem")})):(e.transition({width:"0%"},200,"ease",function(){e.css({height:"100%",padding:"0rem",width:"auto"})}),$("section.max_map").transition({width:"100%"},200,"ease")),null!==userLocation.currentInfobox&&(userLocation.currentInfobox.close(),userLocation.currentInfobox=null)}function searchForEntries(){var e=userLocation.map.getBounds(),o=e.getNorthEast().lat().toFixed(10),t=e.getNorthEast().lng().toFixed(10),n=e.getSouthWest().lat().toFixed(10),i=e.getSouthWest().lng().toFixed(10);$.getJSON("../stadtgedaechtnis/services/get-nearby-locations/"+n+"/"+o+"/"+i+"/"+t+"/",function(e){$.each(e,function(e,o){addMarker(o)})})}function Location(){this.DEFAULT_LAT=50.258,this.DEFAULT_LONG=10.965,this.DEFAULT_LOCATION=new google.maps.LatLng(50.258,10.965),this.positionMarker=null,this.markers={},this.currentInfobox=null}function initialize_Map(){userLocation.map=new google.maps.Map(document.getElementById(MAP_ELEMENT),mapOptions),userLocation.positionMarker=new GeolocationMarker(userLocation.map),userLocation.moveToCurrentLocationOrFallback(),google.maps.event.addListener(userLocation.positionMarker,"geolocation_error",errorLocationCallback),google.maps.event.addListener(userLocation.map,"idle",searchForEntries),google.maps.event.addListener(userLocation.map,"click",closeEntry)}var MAP_ELEMENT="map_canvas",channel="mobile";Location.prototype.moveToCurrentLocationOrFallback=function(){Modernizr.geolocation?google.maps.event.addListenerOnce(this.positionMarker,"position_changed",function(){this.map.setCenter(this.getPosition()),this.map.fitBounds(this.getBounds()),searchForEntries()}):this.moveToLocation(this.DEFAULT_LAT,this.DEFAULT_LONG)},Location.prototype.moveToLocation=function(e){this.map&&(this.map.panTo(e),searchForEntries())};var userLocation=new Location,mapOptions={center:userLocation.DEFAULT_LOCATION,zoom:17,mapTypeControl:!0,mapTypeId:google.maps.MapTypeId.SATELLITE,disableDefaultUI:!0,zoomControl:!0};